{
    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "location": {
            "type": "string",
            "metadata": {
              "description": "location - same as above"
            }
        },
        "FortiManagerName": {
            "type": "string",
            "metadata": {
              "description": "Name for FortiManager virtual appliance."
            }
        },
        "instanceType": {
            "type": "string",
            "defaultValue": "Standard_D2_v2"
        },
        "adminUsername": {
            "type": "string",
            "metadata": {
              "description": "Username for the FortiManager virtual appliance."
            }
        },
        "adminPassword": {
            "type": "securestring",
            "metadata": {
              "description": "Password for the FortiManager virtual appliance."
            }
        },
        "storageAccountName": {
            "type": "string",
            "metadata": {
              "description": "Unique *lowercase* name for the Storage Account where the Virtual Machine's disks will be placed. Note, when deploying a custom template, Azure doesn't check these values for uniqueness."
            }
        },
        "storageAccountResourceGroup": {
          "type": "string",
          "metadata": {
            "description": "Resource Group containing storage account - or new resource group from above (if new storage account)"
          }
        },
        "storageAccountNewOrExisting": {
          "type": "string",
          "defaultValue": "new",
          "allowedValues": [
            "new",
            "existing"
          ],
          "metadata": {
            "description": "Identifies whether to use new or existing Storage Account"
          }
        },
        "storageAccountType": {
            "type": "string",
            "defaultValue": "Standard_LRS"
        },
        "vnetNewOrExisting": {
          "type": "string",
          "defaultValue": "new",
          "allowedValues": [
            "new",
            "existing"
          ],
          "metadata": {
            "description": "Identify whether to use a new or existing vnet"
          }
        },
        "vnetName": {
            "type": "string",
            "metadata": {
              "description": "Name of the Azure virtual network."
            }
        },
        "vnetResourceGroup": {
          "type": "string",
          "metadata": {
            "description": "Resource Group containing the virtual network - or new resource group from above (if new vnet)"
          }
        },
        "vnetAddressPrefix": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
              "description": "Virtual network address space in CIDR notation, example: 10.2.0.0/16"
            }
        },
        "subnetName": {
            "type": "string"
        },
        "subnetPrefix": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
              "description": "Subnet 1 Prefix in CIDR notation, example: 10.2.1.0/24"
            }
        },
        "publicIPNewOrExistingOrNone": {
          "type": "string",
          "defaultValue": "new",
          "allowedValues": [
            "new",
            "existing",
            "none"
          ],
          "metadata": {
            "description": "Identify if to use a public IP and if so whether it is new"
          }
        },
        "publicIPName": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
              "description": "Name of Public IP address resource."
            }
        },
        "publicIPType": {
            "defaultValue": "Static",
            "allowedValues": [
              "Dynamic",
              "Static"
            ],
            "metadata": {
              "description": "Type of public IP address - A 'dynamic' address will change during reboot or periods of inactivity"
            },
            "type": "string"

        },
        "publicIPResourceGroup": {
          "type": "string",
          "defaultValue": "",
          "metadata": {
            "description": "Resource Group containing the public IP - or new resource group from above (if new public IP)"
          }
        },
        "FortinetTags": {
        "type": "object",
        "defaultValue": {
          "provider": "6EB3B02F-50E5-4A3E-8CB8-2E129258317D"
          }
        },
        "artifactsBaseUrl": {
          "type": "string",
          "defaultValue": "https://raw.githubusercontent.com/fortinetclouddev/FortiManager/1.0.4",
          "metadata": {
            "description": "Base URL of the solution template gallery package",
            "artifactsBaseUrl": ""
          }
        }
    },
    "variables": {
        "vnetId": "[resourceId(resourceGroup().name,'Microsoft.Network/virtualNetworks', parameters('vnetName'))]",
      "subnetRef": "[concat(variables('vnetId'), '/subnets/', parameters('subnetName'))]",
      "networkInterfaceName": "[concat(parameters('FortiManagerName'), '-NIC0')]",
        "storageAccountSetupURL": "[concat(parameters('artifactsBaseUrl'),'/','storageAccount-',parameters('storageAccountNewOrExisting'),'.json')]",
        "publicIPSetupURL": "[concat(parameters('artifactsBaseUrl'),'/','publicip-',parameters('publicIPNewOrExistingOrNone'),'.json')]",
        "virtualNetworkSetupURL": "[concat(parameters('artifactsBaseUrl'),'/','vnet-',parameters('vnetNewOrExisting'),'.json')]"
    },
    "resources": [
      {
        "name": "SettingUpStorageAccount",
        "type": "Microsoft.Resources/deployments",
        "apiVersion": "2015-01-01",
        "properties": {
          "mode": "Incremental",
          "templateLink": {
            "uri": "[variables('storageAccountSetupURL')]",
            "contentVersion": "1.0.0.0"
          },
          "parameters": {
            "location": {
              "value": "[parameters('location')]"
            },
            "storageAccountType": {
              "value": "[parameters('storageAccountType')]"
            },
            "storageAccountName": {
              "value": "[parameters('storageAccountName')]"
            },
            "storageAccountExistingRG": {
              "value": "[parameters('storageAccountResourceGroup')]"
            },
            "FortinetTags": {
              "value": "[parameters('FortinetTags')]"
            }
          }
        }
      },
      {
        "name": "SettingUpVirtualNetwork",
        "type": "Microsoft.Resources/deployments",
        "apiVersion": "2015-01-01",
        "dependsOn": [
        ],
        "properties": {
          "mode": "Incremental",
          "templateLink": {
            "uri": "[variables('virtualNetworkSetupURL')]",
            "contentVersion": "1.0.0.0"
          },
          "parameters": {
            "vnetName": {
              "value": "[parameters('vnetName')]"
            },
            "location": {
              "value": "[parameters('location')]"
            },
            "vnetAddressPrefix": {
              "value": "[parameters('vnetAddressPrefix')]"
            },
            "subnet1Name": {
              "value": "[parameters('subnetName')]"
            },
            "subnet1AddressPrefix": {
              "value": "[parameters('subnetPrefix')]"
            },
            "vnetResourceGroup": {
              "value": "[parameters('vnetResourceGroup')]"
            },
            "FortinetTags": {
              "value": "[parameters('FortinetTags')]"
            }
          }
        }
      },
      {
        "apiVersion": "2015-01-01",
        "type": "Microsoft.Resources/deployments",
        "name": "SettingUpPublicIPandFollowing",
        "dependsOn": [
          "[concat('Microsoft.Resources/deployments/', 'SettingUpVirtualNetwork')]"
        ],
        "properties": {
          "mode": "Incremental",
          "templateLink": {
            "uri": "[variables('publicIPSetupURL')]",
            "contentVersion": "1.0.0.0"
          },
          "parameters": {
            "location": {
              "value": "[parameters('location')]"
            },
            "publicIPAddressName": {
              "value": "[parameters('publicIPName')]"
            },
            "publicIPAddressType": {
              "value": "[parameters('publicIPType')]"
            },
            "publicIPAddressResourceGroup": {
              "value": "[parameters('publicIPResourceGroup')]"
            },
            "network_NIC_fg11_Name": {
              "value": "[variables('networkInterfaceName')]"
            },
            "subnet1Ref": {
              "value": "[reference('Microsoft.Resources/deployments/SettingUpVirtualNetwork', '2015-01-01').outputs.subnet1ID.value]"
            },
            "FortinetTags": {
              "value": "[parameters('FortinetTags')]"
            }
          }
        }
      },
      {
            "name": "[parameters('FortiManagerName')]",
            "type": "Microsoft.Compute/virtualMachines",
            "apiVersion": "2015-06-15",
            "tags": {
             "provider": "[toUpper(parameters('FortinetTags').provider)]"
            },
            "location": "[parameters('location')]",
            "dependsOn": [
                "[concat('Microsoft.Resources/deployments/', 'SettingUpPublicIPandFollowing')]",
                "[concat('Microsoft.Resources/deployments/', 'SettingUpStorageAccount')]"
            ],
            "properties": {
                "osProfile": {
                    "computerName": "[parameters('FortiManagerName')]",
                    "adminUsername": "[parameters('adminUsername')]",
                    "adminPassword": "[parameters('adminPassword')]"
                },
                "hardwareProfile": {
                    "vmSize": "[parameters('instanceType')]"
                },
                "storageProfile": {
                    "imageReference": {
                        "publisher": "fortinet",
                        "offer": "fortinet-fortimanager",
                        "sku": "fortinet-fortimanager",
                        "version": "latest"
                    },
                    "osDisk": {
                        "name": "[parameters('FortiManagerName')]",
                        "vhd": {
                            "uri": "[concat('http://',parameters('storageAccountName'),'.blob.core.windows.net/vhds/', parameters('FortiManagerName'), '-osdisk', '.vhd')]"
                        },
                        "createOption": "fromImage"
                    },
                    "dataDisks": [
                      {
                        "name": "[concat(parameters('FortiManagerName'),'-dataDisk')]",
                        "createOption": "Empty",
                        "diskSizeGB": "1023",
                        "lun": 0,
                        "vhd": {
                          "uri": "[concat('http://',parameters('storageAccountName'),'.blob.core.windows.net/vhds/', parameters('FortiManagerName'), '-datadisk', '.vhd')]"
                        }
                      }
                    ]
                },
                "networkProfile": {
                    "networkInterfaces": [
                        {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('networkInterfaceName'))]"
                        }
                    ]
                },
                "diagnosticsProfile": {
                    "bootDiagnostics": {
                        "enabled": true,
                        "storageUri": "[concat('http://', parameters('storageAccountName'), '.blob.core.windows.net')]"
                    }
                }
            },
            "plan": {
                "name": "fortinet-fortimanager",
                "publisher": "fortinet",
                "product": "fortinet-fortimanager"
            }
        }
    ],
    "outputs": {
        "adminUsername": {
            "type": "string",
            "value": "[parameters('adminUsername')]"
        }
    }
}
